---
title: "Gene_Pheno_processing"
author: "Meg Hutch"
date: "January 9, 2020"
output: html_document
---

Objective: Pre-process genebody and phenotypic data for the Multi-Cancer deep learning analysis

```{r Packages}
library(dplyr)
library(caret)
library(DESeq2)
```

```{r Import Data}
# gene count data
gene_count <- read.delim2("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/genebody_count_all.txt", header = TRUE, sep = "")

# gene annotation
gene_ano <- read.delim2("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/genebody_anno.txt", header = TRUE, sep = "")

# Jan 23: updated phenotypic data
pheno <- readRDS("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/DataInfoFilter.rds")

# Fragment length - final ids in the analysis are in this file
fl <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/DataInfoFilter.csv")
```

Map the gene annotations to the gene body data

**strand + or -**
```{r}
gene_ano <- gene_ano %>% select(Geneid)

gene_count <- cbind(gene_ano, gene_count)
```

Modify gene count data - transpose to facilitate merging with phenotypic data 

```{r}
# transpose: rows to columns
gene_count_t <- t(gene_count) 

# convert first row to header
gene_col_names <- gene_count_t[1,]

# transpose column names
colnames(gene_count_t) <- gene_col_names

# remove the geneids from the first row
gene_count_t <- gene_count_t[-1,]

# convert to dataframe
gene_count_t <- as.data.frame(gene_count_t)

# temporarily covert rownames to first column
gene_count_t <- tibble::rownames_to_column(gene_count_t, "seq_num")
```

Add disease to the dataframe
```{r}
disease_vars <- pheno %>% select(seq_num, Cat)

# In the new pheno dataset - some of the healthy patients were given the label CRN to identify non-colon cancers. These are also healthy patients and so I am going to change the label as such
disease_vars$Cat[disease_vars$Cat == "CRN"] <- "HEA"

# Bind to the genes_count_t dataframe
gene_count_t <- full_join(gene_count_t, disease_vars, by = "seq_num")
```

Add Fragment Length (this is the finalized patient list, so if a patient isn't included they will be removed from our gene_count_t df)

We have 342 final patients
```{r}
fl <- fl %>% select(seq_num, frag_mean)

# Merge with gene_counts
gene_count_t  <- merge(gene_count_t, fl, by = "seq_num") 

# Will remove fragment length for now because we shouldn't keep in the gene dataset when normalizing
gene_count_t$frag_mean <- NULL
```

Keep only cancer samples + healthy patients
```{r}
# diagnoses to keep
dx_keep <- c("CRC", "ESCA", "HCC", "HEA", "STAD", "BRCA", "GBM")
dx_keep <- as.data.frame(dx_keep)
colnames(dx_keep) <- "Cat"

# keep only diagnoses of interst
gene_count_t <- gene_count_t %>% filter(Cat %in% dx_keep$Cat)
```

Re-transpose gene counts and create a new dataset, this will be important for trying to normalize data using DEseq2

```{r}
# create a copy of the df
gene_count_2t <- gene_count_t 

# remove disease cat column
gene_count_2t$Cat <- NULL

# Transpose gene_count_t back
gene_count_2t <- t(gene_count_2t)

# convert first row to header
gene_col_names <- gene_count_2t[1,]

# transpose column names
colnames(gene_count_2t) <- gene_col_names

# convert to dataframe
gene_count_2t <- as.data.frame(gene_count_2t)

# remove the firt row as it is a column now
gene_count_2t <- gene_count_2t[-1,]

# temporarily covert rownames to first column
#gene_count_2t <- tibble::rownames_to_column(gene_count_2t, "Geneid")
```


Normalize gene counts using deseq2 and normalizing by disease type

Reference: https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
http://bioconductor.org/packages/release/bioc/manuals/DESeq2/man/DESeq2.pdf
```{r}
# Convert factors to numeric
which( colnames(gene_count_t)=="Cat" ) # don't transform this column --> NA!
cols = c(2:19101)    
gene_count_t[,cols] = apply(gene_count_t[,cols], 2, function(x) as.numeric(as.character(x)))

cols = c(1:342)    
gene_count_2t[,cols] = apply(gene_count_2t[,cols], 2, function(x) as.numeric(as.character(x)))

## Create DESeq2Dataset object where ~ 1 indicates no design
dds <- DESeqDataSetFromMatrix(countData = as.matrix(gene_count_2t), colData = gene_count_t, design = ~Cat)

# run deseq
dds <- DESeq(dds)

#**should design be based on diagnosis? or just indiviudal patient? healthy vs disease? How are unbalanced datasets handled here?
results <- results(dds)
summary(results)

# To retrieve the normalized counts:
normalized_counts <- counts(dds, normalized=TRUE)

# transpose data
normalized_counts <- t(normalized_counts)

# convert to dataframe
normalized_counts <- as.data.frame(normalized_counts)

# convert row names to first column
normalized_counts <- tibble::rownames_to_column(normalized_counts, "seq_num")
```

Process the phenotypic data - we will be focusing on age and gender first
```{r}
pheno_vars <- pheno %>% select(seq_num, Cat, age, gender)
```

Merge phenotypic data with the gene_count data - mc_data frame will be our final dataframe
```{r}
mc_data <- inner_join(pheno_vars, normalized_counts, by = "seq_num")
```

Next we also want to added the cfDNA concentration from the original Cancer info excel file. This was split into separate csvs for each diagnosis and include cfDNA concentration. I will process this data and add to the mc_data df.

```{r}
# breast cancer
brca <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/brca_info.csv")
  
# colon cancer
crc <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/crc_info.csv")
  
# glioblastoma
gbm <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/gbm_info.csv")
  
# esophageal cancer
esca <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/esca_info.csv")

# hepatitis B virus infection
hbv <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hbv_info.csv")

# liver cancer
hcc <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hcc_info.csv")

# stomach cancer
stad <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/stad_info.csv")

# healthy 
hea <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hea_info.csv")
```

Merge all diagnoses together and extract seq_num, diagnosis, and cfDNA concentration. There are a few patients in these csvs that had incomplete information, and thus, it looks like some seq_num ids are repeated and given to other patients. 
```{r}
brca <- brca %>% select(seq_num, diagnosis, dilute_library_concentration)

crc <- crc %>% select(seq_num, diagnosis, dilute_library_concentration)

gbm <- gbm %>% select(seq_num, diagnosis, dilute_library_concentration)

esca <- esca %>% select(seq_num, diagnosis, dilute_library_concentration)

hbv <- hbv %>% select(seq_num, diagnosis, dilute_library_concentration)

hcc <- hcc %>% select(seq_num, diagnosis, dilute_library_concentration)

stad <- stad %>% select(seq_num, diagnosis, dilute_library_concentration)

hea <- hea %>% select(seq_num, diagnosis, dilute_library_concentration)

cohort <- rbind(brca, crc, gbm, esca, hbv, hcc, stad, hea)

# There are blank entries in the cohort - but merging by seq_num and diagnosis should take care of past problems with having multiple seq_num ids
#View(cohort)

# Add SEQ as a prefix
cohort$seq_num <- paste0('SEQ', cohort$seq_num)

# In the new pheno dataset - some of the healthy patients were given the label CRN to identify non-colon cancers. These are also healthy patients and so I am going to change the label as such
mc_data$Cat[mc_data$Cat == "CRN"] <- "HEA"

# Merge with mc_data
colnames(mc_data)[2] <- "diagnosis"
mc_data <- inner_join(cohort, mc_data, by = c("seq_num", "diagnosis"))
```

Add Fragment Length

Sample size does reduce but the fragment length IDs our are final dataset
```{r}
fl <- fl %>% select(seq_num, frag_mean)

# Merge with mc_data
mc_data <- merge(mc_data, fl, by = "seq_num") 
table(mc_data$Cat)
```

Training and Testing Splits for all Cancers Separate

Create balanced datasets:
https://topepo.github.io/caret/data-splitting.html
```{r}
set.seed(02051)
trainIndex <- createDataPartition(mc_data$diagnosis, p = .7, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

mcTrain <- mc_data[trainIndex,]
mcTest  <- mc_data[-trainIndex,]

table(mc_data$diagnosis)
table(mcTrain$diagnosis)
table(mcTest$diagnosis)

round(table(mc_data$diagnosis)/342*100, 1)
round(table(mcTrain$diagnosis)/242*100, 1)
round(table(mcTest$diagnosis)/100*100, 1)
# Yes, looking at percents above shows equal ditributions
```

Check if any missing values: none!
```{r}
sum(is.na(mcTrain))
sum(is.na(mcTest))
```

Combined Colon and Stomach Cancer 

```{r}
# Copy training and testing datasets into new dataframes
mcTrain_cs <- mcTrain
mcTest_cs <- mcTest

# combine Colon and Stomach Cancer
mcTrain_cs$diagnosis[mcTrain_cs$diagnosis == "CRC" | mcTrain_cs$diagnosis == "STAD"] <- "CRC_STAD"

mcTest_cs$diagnosis[mcTest_cs$diagnosis == "CRC" | mcTest_cs$diagnosis == "STAD"] <- "CRC_STAD"

table(mcTrain_cs$diagnosis)
table(mcTest_cs$diagnosis)

round(table(mcTrain_cs$diagnosis)/242*100, 1)
round(table(mcTest_cs$diagnosis)/100*100, 1)
# Yes, looking at percents above shows equal ditributions
```

Check if any missing values: none!
```{r}
sum(is.na(mcTrain_cs))
sum(is.na(mcTest_cs))
```

Save training and test sets
```{r}
write.csv(mc_data, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mc_data.csv", row.names = FALSE)

write.csv(mcTrain, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTrain_70_30.csv", row.names = FALSE)

write.csv(mcTest, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTest_70_30.csv", row.names = FALSE)

write.csv(mcTrain_cs, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTrain_cs_70_30.csv", row.names = FALSE)

write.csv(mcTest_cs, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTest_cs_70_30.csv", row.names = FALSE)
```
