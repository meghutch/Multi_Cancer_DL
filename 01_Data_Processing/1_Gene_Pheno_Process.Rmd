---
title: "Gene_Pheno_processing"
author: "Meg Hutch"
date: "January 9, 2020"
output: html_document
---

Objective: Pre-process genebody and phenotypic data for the Multi-Cancer deep learning analysis.

```{r Packages}
library(dplyr)
library(caret)
```

```{r Import Data}
# gene count data
gene_count <- read.delim2("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/genebody_count_all.txt", header = TRUE, sep = "")

# gene annotation
gene_ano <- read.delim2("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/genebody_anno.txt", header = TRUE, sep = "")

# phenotypic data
#pheno <- read.delim2("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/pheno.txt", header = TRUE, sep = "")

# Jan 23: updated phenotypic data
pheno <- readRDS("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/DataInfoFilter.rds")
```

Map the gene annotations to the gene body data

**Strand + or - ?**
```{r}
gene_ano <- gene_ano %>% select(Geneid)

gene_count <- cbind(gene_ano, gene_count)
```

Modify gene count data - transpose to faciliate merging with phenotypic data 

```{r}
# transpose: rows to columns
gene_count_t <- t(gene_count) 

# convert first row to header
gene_col_names <- gene_count_t[1,]

# transpose column names
colnames(gene_count_t) <- gene_col_names

# remove the geneids from the first row
gene_count_t <- gene_count_t[-1,]

gene_count_t <- as.data.frame(gene_count_t)

# temporarily covert rownames to first column
gene_count_t <- tibble::rownames_to_column(gene_count_t, "seq_num")
```

Process the phenotypic data - we will be focusing on age and gender first
```{r}
pheno_vars <- pheno %>% select(seq_num, Cat, age, gender)
```

Merge phenotypic data with the gene_count data - mc_data frame will be our final dataframe
```{r}
mc_data <- inner_join(pheno_vars, gene_count_t, by = "seq_num")
```

Next we also want to added the cfDNA concentration from the original Cancer info excel file. This was split into separate csvs for each diagnosis and include cfDNA concentration. I will process this data and add to the mc_data df.

```{r}
# breast cancer
brca <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/brca_info.csv")
  
# colon cancer
crc <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/crc_info.csv")
  
# glioblastoma
gbm <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/gbm_info.csv")
  
# esophageal cancer
esca <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/esca_info.csv")

# hepatitis B virus infection
hbv <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hbv_info.csv")

# liver cancer
hcc <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hcc_info.csv")

# stomach cancer
stad <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/stad_info.csv")

# healthy 
hea <- read.csv("C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/Raw_Data/hea_info.csv")
```

Merge all diagnoses together and extract seq_num, diagnosis, and cfDNA concentration. There are a few patients in these csvs that had incomplete information, and thus, it looks like some seq_num ids are repeated and given to other patients. The processing below should remove patients with incomplete data and maintain the 373 patient dataset.
```{r}
brca <- brca %>% select(seq_num, diagnosis, dilute_library_concentration)

crc <- crc %>% select(seq_num, diagnosis, dilute_library_concentration)

gbm <- gbm %>% select(seq_num, diagnosis, dilute_library_concentration)

esca <- esca %>% select(seq_num, diagnosis, dilute_library_concentration)

hbv <- hbv %>% select(seq_num, diagnosis, dilute_library_concentration)

hcc <- hcc %>% select(seq_num, diagnosis, dilute_library_concentration)

stad <- stad %>% select(seq_num, diagnosis, dilute_library_concentration)

hea <- hea %>% select(seq_num, diagnosis, dilute_library_concentration)

cohort <- rbind(brca, crc, gbm, esca, hbv, hcc, stad, hea)

# There are blank entries in the cohort - but merging by seq_num and diagnosis should take care of past problems with having multiple seq_num ids
#View(cohort)

# Add SEQ as a prefix
cohort$seq_num <- paste0('SEQ', cohort$seq_num)

# In the new pheno dataset - some of the healthy patients were given the label CRN to identify non-colon cancers. These are also healthy patients and so I am going to change the label as such
mc_data$Cat[mc_data$Cat == "CRN"] <- "HEA"

# Merge with mc_data
colnames(mc_data)[2] <- "diagnosis"
mc_data <- inner_join(cohort, mc_data, by = c("seq_num", "diagnosis")) # missing 19 patients?
```

Examine all diagnosis information

```{r}
table(mc_data$diagnosis)
```

To start - I am going to examine esophageal, liver, colon, and stomach cancer. I will also include healthy patients

```{r}
# diagnoses to keep
dx_keep <- c("CRC", "ESCA", "HCC", "HEA", "STAD")
dx_keep <- as.data.frame(dx_keep)
colnames(dx_keep) <- "diagnosis"
mc_data <- mc_data %>% filter(diagnosis %in% dx_keep$diagnosis)
table(mc_data$diagnosis)
```

Create balanced datasets:
https://topepo.github.io/caret/data-splitting.html
```{r}
set.seed(3456)
trainIndex <- createDataPartition(mc_data$diagnosis, p = .8, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)

mcTrain <- mc_data[trainIndex,]
mcTest  <- mc_data[-trainIndex,]

table(mc_data$diagnosis)
table(mcTrain$diagnosis)
table(mcTest$diagnosis)

table(mc_data$diagnosis)/295*100
table(mcTrain$diagnosis)/238*100
table(mcTest$diagnosis)/57*100
# Yes, looking at percents above shows equal ditributions
```

Check if any missing values: none!
```{r}
sum(is.na(mcTrain))
sum(is.na(mcTest))
```

Save training and test sets
```{r}
write.csv(mcTrain, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTrain.csv", row.names = FALSE)

write.csv(mcTest, file = "C:/Users/User/Box Sync/Projects/Multi_Cancer_DL/02_Processed_Data/mcTest.csv", row.names = FALSE)
```

